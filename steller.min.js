var LOG_LEVEL=1;org="undefined"===typeof org?{}:org;org.anclab=org.anclab||{};org.anclab.steller=org.anclab.steller||{};
(function(o,q){function t(a){var b={};a.on=function(a,d){var a=z(a),f=b[a]||(b[a]={}),p=d.__steller_eventable_id__||0;if(p in f)return this;p||Object.defineProperty(d,"__steller_eventable_id__",{value:p=K++,enumerable:!1,configurable:!1,writable:!1});f[p]=d;return this};a.off=function(a,d){var a=z(a),f=b[a];if(!f)return this;var p=d&&d.__steller_eventable_id__||0;p?delete f[p]:d||delete b[a];return this};a.emit=function(a){var a=z(a),d=b[a];if(!d)return this;for(var f in d)try{d[f].apply(this,arguments)}catch(p){1<=
LOG_LEVEL&&console.log("eventable.js[107]:\t","Exception in event watcher - ",p)}return this};return a}function i(a){var b=Object.create(i.prototype);b.spec=a=r(Object.create(a));b.getter=void 0;b.setter=void 0;b.valueOf=void 0;b.audioParam=void 0;b.watchers=[];b._value=void 0;a.audioParam?(b.audioParam=a.audioParam,b.getter=a.getter||i.getters.audioParam,b.setter=a.setter||i.setters.audioParam):a.options?(b.getter=a.getter||i.getters.value,b.setter=a.setter||i.setters.option):(b.getter=a.getter||
i.getters.value,b.setter=a.setter||i.setters.value);b.valueOf=b.getter;"value"in a&&b.setter(a.value);return b}function r(a){if(a.options){var b={};a.options.forEach(function(a,d){b["option:"+a]=d+1});a.limit=function(c){if("number"===typeof c){if(0<=c&&c<a.options.length)return a.options[c];throw Error("Invalid enumeration index");}if(b["option:"+c])return c;throw Error("Invalid enumeration value");}}return a}function k(a,b){var c,d,f=a.watchers;c=0;for(d=f.length;c<d;++c)f[c](b,a);return b}function u(){var a=
0,b=4,c=[null,null,null,null],d=-1,f=0;this.length=0;this.add=function(p){if(a>=b){var g=Array(2*b),e,h,n,m;e=d;h=0;n=a;for(m=b;h<n;++h,e=(e+1)%m)g[h]=c[e];c=g;f=a;d=0===a?-1:0;b*=2}c[f]=p;0>d&&(d=f);f=(f+1)%b;return this.length=a+=1};this.remove=function(){if(0>=a)throw Error("Empty queue");var f=c[d];c[d]=null;d=(d+1)%b;this.length=a-=1;return f};this.clear=function(){this.length=a=0;c.splice(0,c.length,null,null,null,null);b=4;d=-1;f=0};return this}function j(a,b){var c=g();if(e()&&!c)throw Error("PeriodicTimer needs requestAnimationFrame support. Use a sufficiently modern browser.");
var d=this,f=!1,p,b=void 0===b?15:Math.min(Math.max(e()?15:1,b),33);c&&12<=b?(d.start=function(){f||(f=!0,c(function(){f&&(c(arguments.callee),a())}))},d.stop=function(){f=!1}):(d.start=function(){f||(f=!0,p=setInterval(a,1))},d.stop=function(){f&&(f=!1,clearInterval(p),p=void 0)});d.__defineGetter__("running",function(){return f});d.__defineSetter__("running",function(a){a?d.start():d.stop();return f});d.computeAheadInterval_secs=Math.round(3.333*b)/1E3;return d}function s(a){(o.JSNodeTimer_jsnodes||
(o.JSNodeTimer_jsnodes=[])).push(a)}function l(a,b,c,d){this.dt=c;this.t1=a;this.t2=a+c;this.t1r=b;this.t2r=b+d.valueOf()*c;this.rate=d;this.data=null;return this}function h(a){return Math.round(1E3*a)/1E3}function e(){return"object"===typeof o&&"object"===typeof document&&o.document===document}function g(){try{return o.requestAnimationFrame||o.webkitRequestAnimationFrame||o.mozRequestAnimationFrame||o.msRequestAnimationFrame||function(a){setTimeout(a,1E3/60)}}catch(a){}}function w(){(function(){function a(a,
f,c){a[c]=a[c]||a[f];b(a,f,c)}function b(a,f,b){var c=a[f];a[f]=function(){console.warn("Web Audio API: Deprecated name %s used. Use %s instead.",f,b);a[f]=c||a[b];return c.apply(this,arguments)}}var c=this;c.AudioContext=function(c){if(c)return function(){var f,p,e;if(0===arguments.length)f=new c;else if(3===arguments.length)f=new c(arguments[0],arguments[1],arguments[2]);else throw Error("Invalid instantiation of AudioContext");a(f,"createGainNode","createGain");a(f,"createDelayNode","createDelay");
a(f,"createJavaScriptNode","createScriptProcessor");p=Object.getPrototypeOf(f.createGain().gain);e=Object.getPrototypeOf(p);e.setValueAtTime&&(console.warn("Implementation uses extra dummy interface for AudioGainParam. This will be removed."),p=e);a(p,"setTargetValueAtTime","setTargetAtTime");p=Object.getPrototypeOf(f.createBufferSource());a(p,"noteOff","stop");p.start?(b(p,"noteOn","start"),b(p,"noteGrainOn","start")):(console.warn("Web Audio API: Only BufferSource.note[Grain]On available. Providing BufferSource.start."),
p.start=function(a,f,b){switch(arguments.length){case 1:return this.noteOn(a);case 3:return this.noteGrainOn(a,f,b);default:throw Error("Invalid arguments to BufferSource.start");}},b(p,"noteOn","start"),b(p,"noteOff","stop"));p=Object.getPrototypeOf(f.createOscillator());a(p,"noteOn","start");a(p,"noteOff","stop");return f};console.warn("Web Audio API not supported on this client.")}(c.AudioContext||c.webkitAudioContext);c.webkitAudioContext=function(){console.warn('Use "new AudioContext" instead of "new webkitAudioContext".');
switch(arguments.length){case 0:return new c.AudioContext;case 3:return new c.AudioContext(arguments[0],arguments[1],arguments[2]);default:throw Error("Invalid AudioContext creation");}}})();return AudioContext}function n(){try{var a=o.performance,b=a&&(a.now||a.webkitNow||a.mozNow);if(b)return function(){return 0.0010*b.call(a)}}catch(c){}return function(){return 0.0010*Date.now()}}var z=function(){var a={};return function(b){if(a[b])throw Error("Invalid event name - "+b);return b}}(),K=1;t.observe=
function(a,b,c){var c=z(c||b),d=a[b];a[b]=function(){var a=d.apply(this,arguments),b=Array.prototype.slice.call(arguments);b.unshift(c);this.emit.apply(this,b);return a};return a};var B=function(){function a(f,c,d){f.inputs=c||[];f.outputs=d||[];f.numberOfInputs=f.inputs.length;f.numberOfOutputs=f.outputs.length;f.context=f.inputs[0]&&f.inputs[0].context||f.outputs[0]&&f.outputs[0].context;f.connect=function(a,b,c){var d,a=a||f.context.destination,b=f.outputs[b||0];d=a.inputs?a.inputs[c||0]:a;if("AudioParam"===
d.constructor.name||"AudioGain"===d.constructor.name)b.connect(d);else if(d.numberOfInputs===b.numberOfOutputs){a=0;for(c=d.numberOfInputs;a<c;++a)b.connect(d,a,a)}else b.connect(d);return f};f.disconnect=function(){0<arguments.length?Array.prototype.forEach.call(arguments,function(a){f.outputs[a].disconnect()}):f.outputs.forEach(function(a){a.disconnect()});return f};var e={},g=b(f);f.keep=function(a){var a=a||f,c=b(a);return e[c]=a};f.drop=function(f){f?(f=b(f),delete e[f]):delete a._preservedNodes[g]};
a._preservedNodes[g]=e;return f}function b(a){var b=a[d];b||(b=c++,Object.defineProperty(a,d,{value:b,writable:!1,enumerable:!1,configurable:!1}));return b}var c=1,d="#org.anclab.steller.GraphNode.globalid";a._preservedNodes={};a.chain=function(b){var c,d;c=0;for(d=b.length-1;c<d;++c)b[c].connect(b[c+1]);return a};return a}();i.getters={value:function(){return this._value},audioParam:function(){return this.audioParam.value}};i.setters={value:function(a){return this._value=a},audioParam:function(a){return this.audioParam.value=
a},option:function(a){return this._value=this.spec.limit(a)}};i.mappings={};i.mappings.linear={fromNorm:function(a,b){return a.spec.min+b*(a.spec.max-a.spec.min)},toNorm:function(a){return(a.value-a.spec.min)/(a.spec.max-a.spec.min)}};i.mappings.log={fromNorm:function(a,b){var c=a.spec,d=Math.log(c.min),c=Math.log(c.max);return Math.exp(d+b*(c-d))},toNorm:function(a){var b=a.spec,c=Math.log(b.min),b=Math.log(b.max);return(Math.log(a.value)-c)/(b-c)}};i.names=function(a){return Object.keys(a).filter(function(b){return a[b]instanceof
i})};i.expose=function(a,b,c){c||(c=i.names(a));c.forEach(function(c){b[c]=a[c]});return i};i.bind=function(a,b,c){a instanceof i?a.bind(b,c):"value"in a?c?c.update(function(){b.value=a.value}):b.value=a.value:c?c.update(function(){b.value=a}):b.value=a;return i};i.prototype.__defineGetter__("value",function(){return this.getter()});i.prototype.__defineSetter__("value",function(a){return a!==this.getter()?k(this,this.setter(a)):a});i.prototype.watch=function(a){var b,c,d=this.watchers;b=0;for(c=d.length;b<
c;++b)if(d[b]===a)return this;d.push(a);return this};i.prototype.unwatch=function(a){var b=this.watchers;if(1>arguments.length||!a)return b.splice(0,b.length),this;for(var c=b.length-1;0<=c;--c)if(b[c]===a){b.splice(c,1);break}return this};i.prototype.changed=function(){k(this,this.getter());return this};i.prototype.alias=function(a,b){var c=this,d=Object.create(c);d.spec=Object.create(c.spec);d.spec.name=a;b&&(d.spec.label=b);d.getter=function(){return c.getter()};d.setter=function(a){return c.setter(a)};
d.alias=function(a,b){return c.alias(a,b)};return d};i.prototype.bind=function(a,b){var c=this;if(a.addEventListener){var d=c.spec,f=d.mapping?i.mappings[d.mapping]:i.mappings.linear,e,g,h;if("checkbox"===a.type)e=function(){c.value=a.checked?1:0},g=b?function(){b.update(e)}:e,h=function(b){a.checked=b?!0:!1};else if("range"===a.type)e=function(){c.value=f.fromNorm(c,parseFloat(a.value))},g=b?function(){b.update(e)}:e,h=function(){a.value=f.toNorm(c)};else throw Error("org.anclab.steller.Param.bind: Unsupported control type - "+
a.type);h.elem=a;h.unbind=function(){a.removeEventListener(g);c.unwatch(h)};a.addEventListener("change",g);c.watch(h);h(c.value)}else if("string"===typeof a){var d=document.querySelectorAll(a),n,l;n=0;for(l=d.length;n<l;++n)this.bind(d[n])}else{var m=function(b){a.value=b};m.elem=a;m.unbind=function(){c.unwatch(m)};c.watch(m);a.value=c.value}return this};i.prototype.unbind=function(a){if("string"===typeof a){var a=document.querySelectorAll(a),b,c;b=0;for(c=a.length;b<c;++b)this.unbind(a[b])}else{var d=
this.watchers;b=0;for(c=d.length;b<c;++b)if(d[b].elem===a){d[b].unbind();break}}return this};l.prototype.toString=function(){return JSON.stringify([this.t1r,this.t2r-this.t1r,this.t1,this.t2-this.t1].map(h))};l.prototype.copy=function(){var a=new l(this.t1,this.t1r,this.dt,this.rate);this.data&&(a.data=Object.create(this.data));return a};l.prototype.advance=function(a){this.t1+=a;this.t2+=a;return this};l.prototype.advanceTo=function(a){return this.advance(a-this.t1)};l.prototype.tick=function(){this.t1=
this.t2;this.t2+=this.dt;this.t1r=this.t2r;this.t2r+=this.dt*this.rate.valueOf();return this};l.prototype.jumpTo=function(a){var a=a-this.t1,b=a*this.rate.valueOf();this.t1+=a;this.t2+=a;this.t1r+=b;this.t2r+=b;return this};l.prototype.syncWith=function(a){this.t1=a.t1;this.t2=this.t1+this.dt;this.t1r=a.t1r;this.t2r=this.t1r+this.rate.valueOf()*this.dt;return this};l.prototype.nudgeToRel=function(a){a=Math.max(this.t1r,a);this.t2r>this.t1r&&(this.t1+=(a-this.t1r)*(this.t2-this.t1)/(this.t2r-this.t1r));
this.t1r=a;return this};l.prototype.rel2abs=function(a){return this.t1+(a-this.t1r)/this.rate.valueOf()};l.prototype.abs2rel=function(a){return this.t1r+(a-this.t1)*this.rate.valueOf()};var x=function(a){function b(a){var b=Math.pow(10,4-Math.min(3,(""+(a-a%1)).length));return Math.round(a*b)/b}function c(a){return function(b){a.insertAdjacentElement("beforeend",b)}}a.basicUI=function(a,f,e){if(f.ui)return f.ui;var g=a.createElement("div");e&&g.insertAdjacentHTML("beforeend","<p><b>"+e+"</b></p>");
i.names(f).map(function(a){var b=Object.create(f[a].spec);b.name=b.name||a;b.param=f[a];return b}).forEach(function(f){var e=f.name,h=f.param;if("min"in f&&"max"in f){var n=a.createElement("div"),p=a.createElement("span"),l=a.createElement("span");p.innerText=(f.label||e)+": ";p.style.width="100px";p.style.display="inline-block";p.style.textAlign="left";var k=a.createElement("input");k.type="range";k.min=0;k.max=1;k.step=0.0010;var j="string"===typeof f.mapping?i.mappings[f.mapping]:f.mapping||i.mappings.linear,
w=f.units?" "+f.units:"";k.value=j.toNorm(h);l.innerText=" ("+b(h.value)+w+")";k.changeModelParameter=function(){h.value=j.fromNorm(h,parseFloat(this.value))};k.changeSliderValue=function(a){k.value=j.toNorm(h);l.innerText=" ("+b(a)+w+")"};k.addEventListener("change",k.changeModelParameter);h.watch(k.changeSliderValue);[p,k,l].forEach(c(n));g.insertAdjacentElement("beforeend",n)}});return f.ui=g};return a}({});q.Eventable=t;q.AsyncEventable=function(a){var a=t(a),b=a.on;a.on=function(c,d){if(!d)return this;
var f=d.__steller_async_eventable__;f||Object.defineProperty(d,"__steller_async_eventable__",{value:f=function(){var b=arguments;setTimeout(function(){d.apply(a,b)},0)},enumerable:!1,configurable:!1,writable:!1});b(c,f)};return a};q.GraphNode=B;q.SoundModel=function(a,b,c){a=t(B(a,b,c));t.observe(a,"connect");t.observe(a,"disconnect");return a};q.Param=i;q.Scheduler=function(a,b){function c(a,b){a&&(r.add(a),r.add(b))}function d(a){a(m,v.copy(),f)}function f(){}function h(a,b,c){c&&c(a,b,f)}function k(a,
b){return function(c,d,e){function g(c,d){var A=n+a.valueOf();0<D&&d.t1<v.t1&&d.advance(D);d.t1>G?h&&C.add(h):d.t2r<A?(b&&b(d,d.t1r,d.t2r,n,A),d.tick(),h&&C.add(h)):(b&&A>=d.t1r&&b(d,d.t1r,A,n,A),d.t2r>d.t1r?e(c,d.nudgeToRel(A),f):e(c,d,f))}function h(a){g(a,d,f)}var n=d.t1r;g(c,d)}}function s(a){return function(b,c,f){a(c)(b,c,f)}}function z(a){function b(a,d,e){var g,h,F;if(0<c.length){F=c;c=[];g=0;for(h=F.length;g<h;++g)F[g](a,d.copy(),f)}e(a,d,f)}if(0<arguments.length)return function(a,b,c){for(;a<
b;++a)c.push(z());return c}(0,a,[]);var c=[];b.play=function(a){c.push(a);return this};b.cancel=function(){c.splice(0,c.length);return this};return b}function K(a){function b(a,d,g){e?g(a,d,f):c.push({sched:a,next:g,clock:d})}if(0<arguments.length)return function(a,b,c){for(;a<b;++a)c.push(K());return c}(0,a,[]);var c=[],d=[],e=!0;b.__defineGetter__("isOpen",function(){return e});b.__defineSetter__("isOpen",function(a){a?b.open():b.close();return a});b.open=function(a,b,d){e=!0;var g=c,h,F,n,k=E();
c=[];h=0;for(F=g.length;h<F;++h)n=g[h],n.next(n.sched,b?b.copy():n.clock.advanceTo(k),f);d&&d(a,b,f)};b.close=function(a,b,c){e=!1;c&&c(a,b,f)};b.toggle=function(a,c,f){return e?b.close(a,c,f):b.open(a,c,f)};b.cancel=function(a,b,d){c.splice(0,c.length);d&&d(a,b,f)};b.push=function(a,b,g){d.push({isOpen:e,cache:c});c=[];g&&g(a,b,f)};b.pop=function(a,b,e){var g=d.pop();c.push.apply(c,g.cache);this.isOpen=g.isOpen;e&&e(a,b,f)};return b}var m=this===o?{}:this,B=g();w();if(e()&&!B)throw Error("Scheduler needs requestAnimationFrame support. Use a sufficiently modern browser version.");
var q=0.0010,E=function(){if(a){if(a.createGain||a.createGainNode)return q=1/a.sampleRate,a.createGain=a.createGainNode=a.createGain||a.createGainNode,a.createGainNode(),function(){return a.currentTime};throw Error("Scheduler: Argument is not an audio context");}return n()||function(){return 0.0010*Date.now()}}(),M,x=!1;m.__defineGetter__("running",function(){return x});m.__defineSetter__("running",function(a){a?x||(x=!0,v.advanceTo(E()),M.start()):(x=!1,M.stop())});m.frame_rate=i({min:15,max:75,
value:60});var C=new u("tick"),r=new u("frames"),J=new u("update");M=new j(function(){var a,b,c,f,d;a=!0;b=E();V(b);for(G=b+H;b-v.t1>S;)D=b-v.t1,v.advance(D);for(;a||v.t1<G;){if(0<J.length){c=J.length;for(a=0;a<c;++a)J.remove()()}c=C.length;for(a=0;a<c;++a)C.remove()(m,v,h);v.t1<G&&v.tick();D=0;a=!1}if(0<r.length){c=r.length;for(a=0;a<c;a+=2)f=r.remove(),d=r.remove(),f(b,d)}if(m.ontick)m.ontick(b)},0,a);var t=1/60,N=t,H=M.computeAheadInterval_secs||0.05,S=5*H,v=new l(E(),0,H,1),G=v.t1,D=0,V=function(){var a=
1/60,b=v.t1,c=15;return function(f){var d=f-b;0.01<d&&0.07>d&&(N=t=a+=0.05*(d-a),H=3.33*t,S=5*H,0>=c--&&(m.frame_rate.value=Math.round(1/t),c=15));b=f}}(),T=function(){return a?function U(b){0===a.currentTime?setTimeout(U,100,b):(v=new l(E(),0,H,1),G=v.t1,m.play=T=d,d(b))}:d}(),O;b&&b.diagnostics?(4<=LOG_LEVEL&&console.log("scheduler.js[631]:\t","fire: diagnostics on"),O=function(a){return function(b,c,d){E();a(c);d(b,c,f)}}):O=function(a){return function(b,c,d){a(c);d(b,c,f)}};m.audioContext=a;m.update=
function(a){a&&J.add(a)};m.perform=function(a,b,c){a(m,b,c)};m.cancel=function(){J.clear();C.clear();r.clear()};m.play=T;m.stop=f;m.cont=h;m.delay=k;m.loop=function(a){return function A(b,c){a(b,c,A)}};m.loop_while=function(a,b){return function(c,d,e){function g(){a.valueOf()?b(c,d,g):e(c,d,f)}g()}};m.repeat=function(a,b){return function(c,d,e){function g(){if(h<a){h++;b(c,d,g)}else e(c,d,f)}var h=0;g()}};m.fork=function(a){a=a&&a.constructor===Function?Array.prototype.slice.call(arguments,0):a.slice(0);
return function(b,c,d){function e(b,h){g++;g===a.length&&d(b,c.syncWith(h),f)}var g=0;a.forEach(function(a){a(b,c.copy(),e)})}};m.spawn=function(a){a=a&&a.constructor===Function?Array.prototype.slice.call(arguments,0):a.slice(0);return function(b,c,d){a.forEach(function(a){a(b,c.copy(),f)});d(b,c,f)}};m.dynamic=s;m.track=function(a){function b(c,d,e,g,h){function n(b,c){if(k<m)a[k++](b,c,n);else e(b,c,f)}var k=0,m=a.length;if(arguments.length>3){k=g;m=h}n(c,d,e)}a&&a.constructor===Function&&(a=Array.prototype.slice.call(arguments,
0));b.minIndex=0;b.maxIndex=a.length;b.models=a;return b};m.slice=function(a,b,c){c=arguments.length>2?c:a.maxIndex;b=arguments.length>1?Math.max(a.minIndex,Math.min(b,c)):a.minIndex;return function(d,f,e){a(d,f,e,b,c)}};m.fire=O;m.display=function(a){return function(b,d,e){function g(b){b+N>h?a(d,h,b):c(g)}var h=d.t1;c(g);e(b,d,f)}};m.frame=function(a){return function(b,d,e){function g(n){if(n+N>h){d.jumpTo(n);a(d);e(b,d,f)}else c(g)}var h=d.t1;c(g)}};m.frames=function(a,b){return function(d,e,g){function h(b,
c){var d,e=k+a.valueOf();if(D>0&&c.t1<v.t1){c.advance(D);if(j){p=p+void 0;j.intervals.length>4&&j.intervals.splice(0,j.intervals.length-4);if(j.intervals.length>0){j.intervals[0]=j.intervals[0]+void 0;j.intervals[3]=c.rate.valueOf()}}}if(c.t1>G)n&&C.add(n);else{if(j&&c.t1r<=e){j.endTime=e;var l=c.rate.valueOf();for(d=Math.max(0.0010,t*l);m<c.t2r;){j.intervals.push(p);j.intervals.push(m);j.intervals.push(m+d);j.intervals.push(l);m=m+d}}if(c.t2r<e){c.tick();n&&C.add(n)}else{j.end=true;c.t2r>c.t1r?g(b,
c.nudgeToRel(e),f):g(b,c,f)}}}function n(a){h(a,e,f)}var k=e.t1r,m=k,p=e.t1,l,j;if(b){l=function(a,d){if(d.intervals.length>0){var f=d.intervals[0],e=d.intervals[1],g=d.intervals[2],h=d.intervals[3];if(e<=d.endTime){if(f<N+a){b(d.clock,e,g,d.startTime,d.endTime,h);d.intervals.splice(0,4)}c(l,d);return}}d.end||c(l,d)};j={clock:e,intervals:[],startTime:e.t1r,endTime:e.t1r+a.valueOf(),end:false};c(l,j)}h(d,e)}};m.log=function(a){return O(function(){console.log(a)})};m.anim=function(a,b){var c,d,f,e;
switch(arguments.length){case 3:e=arguments[2];break;case 4:c=arguments[2];d=arguments[3];e=function(a){return(1-a)*c.valueOf()+a*d.valueOf()};break;case 5:c=arguments[2];d=arguments[3];f=arguments[4];e=function(a){a=f(a);return(1-a)*c.valueOf()+a*d.valueOf()};break;default:throw Error("Invalid arguments to anim()");}return a.constructor.name==="AudioGain"||a.constructor.name==="AudioParam"?k(b,function(b,c,d,f,g){var g=g-f,h;if(c<=f){h=g>q?(c-f)/g:0;a.setValueAtTime(e(h),b.rel2abs(c))}a.linearRampToValueAtTime(e(g>
q?(d-f)/g:1),b.rel2abs(d))}):k(b,function(b,c,d,f,g){b=g-f-(d-c);a.value=b>q?e((c-f)/b):e(1)})};m.rate=function(a){return function(b,c,d){c.rate=a;d(b,c,f)}};m.choice=function(a){return s(function(){return a[Math.floor(Math.random()*a.length)]})};m.sync=z;m.gate=K;m.stats=function(){return{frame_jitter_ms:0}};m.running=b&&"running"in b&&b.running||!0;org.anclab.steller.Models&&(m.models=org.anclab.steller.Models(m));return m};q.Clock=l;q.PeriodicTimer=j;q.JSNodeTimer=function(a,b,c){if(c){var d=c.createJavaScriptNode(1024);
d.onaudioprocess=function(){a()};var f=this,e=!1;s(d);f.start=function(){e||(e=!0,d.connect(c.destination))};f.stop=function(){e&&(d.disconnect(),e=!1)};f.__defineGetter__("running",function(){return e});f.__defineSetter__("running",function(a){a?f.start():f.stop();return e});f.computeAheadInterval_secs=Math.round(2560)/c.sampleRate;return f}return j.call(this,a,b)};q.UI=x;q.Util={p2f:function(a){return 440*Math.pow(2,(a.valueOf()-69)/12)},f2p:function(a){a=69+12*Math.log(a.valueOf()/440)/Math.LN2;
return Math.round(100*a)/100},augment:function(a,b){var c=org.anclab.steller;if(a in c)c[a].augmentors.push(b);else{var d=function(){var a=Array.prototype.slice.call(arguments,0),b={};d.augmentors.forEach(function(c){b=c.apply(b,a)||b});return b};d.augmentors=[b];c[a]=d}return c[a]}};q.requestAnimationFrame=function(a){return function(b){return a(b)}}(g());q.AudioContext=w()})(function(){return"undefined"===typeof window?void 0:window}(),org.anclab.steller);
org.anclab.steller.Util.augment("Models",function(o){var q=org.anclab.steller,t=org.anclab.steller.Util,i=q.SoundModel,r=q.Param,k=o.audioContext,u=this;u.chime=function(){var j=k.createGainNode(),s=i({},[],[j]);s.halfLife=r({min:0.0010,max:10,value:0.5,mapping:"log"});s.attackTime=r({min:0.0010,max:1,value:0.01,mapping:"log"});s.level=r({min:0.125,max:4,audioParam:j.gain,mapping:"log"});s.play=function(l,h){void 0===h&&(h=1);return o.fire(function(e){var g=t.p2f(l.valueOf()),i=k.createOscillator();
i.type=i.SINE;i.frequency.value=g;var n=k.createGainNode();n.gain.value=0;n.gain.setValueAtTime(0,e.t1);n.gain.linearRampToValueAtTime(h.valueOf()/8,e.t1+s.attackTime.value);var g=440*s.halfLife.value/g,z=10*g;n.gain.setTargetAtTime(0,e.t1+s.attackTime.value,g);i.connect(n);n.connect(j);i.start(e.t1);i.stop(e.t1+z)})};return s};u.dc=function(){var j,s,l;l=k.createBuffer(1,1024,k.sampleRate);s=l.getChannelData(0);for(j=0;1024>j;++j)s[j]=1;return function(h){var e=k.createBufferSource();e.buffer=l;
e.loop=!0;e.start(0);var g=k.createGainNode();g.gain.value=h;e.connect(g);h=i({},[],[g]);h.level=r({min:-1,max:1,audioParam:g.gain});h.stop=function(g){e.stop(g)};return h}}();u.noise=function(){var j=k.createBuffer(1,5*k.sampleRate,k.sampleRate),s,l,h=j.getChannelData(0);s=0;for(l=h.length;s<l;++s)h[s]=2*Math.random()-1;return function(){var e=k.createBufferSource();e.buffer=j;e.loop=!0;e.gain.value=1;var g=k.createGainNode();g.gain.value=1;e.connect(g);e.start(0);var h=u.dc(0);h.connect(g);g=i({},
[],[g]);g.spread=r({min:0.01,max:10,audioParam:e.gain,mapping:"log"});g.mean=h.level;return g}}();u.probe=function(){var j=r({min:-1,max:1,value:0}),s=r({min:-1,max:1,value:1}),l=r({min:0,max:1,value:0}),h=k.createScriptProcessor(512,1,1),e=0,g=0,w=1-Math.exp(Math.log(0.5)/1024);h.onaudioprocess=function(h){for(var h=h.inputBuffer.getChannelData(0),k=h.length,i=0,o=0,i=0;i<k;++i)o=h[i],e+=w*(o-e),g+=w*(o*o-g);j.value=e;l.value=g;s.value=Math.sqrt(Math.max(0,g-e*e))};h.connect(k.destination);h=i({},
[h],[]);h.mean=j;h.sigma=s;h.energy=l;return h};u.mic=function(){function j(h,e,g){try{navigator.webkitGetUserMedia(h,e,g)}catch(k){g(k)}}function s(h,e){l||(l=k.createMediaStreamSource(e));l.connect(h.outputs[0]);h.error=null;h.ready.value=1}var l;return function(){var h=k.createGainNode(),e=i({},[],[h]);e.ready=r({min:-1,max:1,value:0});e.gain=r({min:0,max:1,audioParam:h.gain});l?s(e,null):j({audio:!0},function(g){return s(e,g)},function(g){e.error=g;e.gain.value=0;e.ready.value=-1});return e}}();
u.spectrum=function(j,s){function l(){if(w){var g=k.currentTime;h.getFloatFrequencyData(e.bins);for(var j=0,i=e.bins,s=i.length;j<s;++j)i[j]=Math.pow(10,i[j]/20);w=q.requestAnimationFrame(l);e.time.value=g}}var j=j||1024,h=k.createAnalyser();h.fftSize=2*j;h.frequencyBinCount=j;h.smoothingTimeConstant=2>arguments.length?0.1:s;var e=i({},[h],[]);e.bins=new Float32Array(j);e.freqs=new Float32Array(j);e.time=r({min:0,max:1E9,value:0});for(var g=0;g<j;++g)e.freqs[g]=g*k.sampleRate/h.fftSize;var w;e.start=
o.fire(function(){w||(w=q.requestAnimationFrame(l))});e.stop=o.fire(function(){w=void 0});return e};(function(){var j={};u.load_sample=function(i,l,h){var e="sound:"+i,g=j[e];if(g)return l&&l(g),g;if(l){var o=new XMLHttpRequest;o.open("GET",i,!0);o.responseType="arraybuffer";o.onerror=function(e){h&&h(e,i)};o.onload=function(){k.decodeAudioData(o.response,function(g){l(j[e]=g);0<=LOG_LEVEL&&console.log("models/sample.js[31]:\t","Sound ["+i+"] loaded!")},function(e){h&&h(e,i)})};o.send()}};u.load_sample.clearCache=
function(){j={}};u.sample=function(j,l){function h(h,j,i,l,o){var a=k.createBufferSource();a.buffer=q;a.connect(e);a.playbackRate.value=j;a.gain.setValueAtTime(0,h.t1);a.gain.setTargetAtTime(i,h.t1,g.attackTime.value/3);3<arguments.length?a.noteGrainOn(h.t1,l,4<arguments.length?o:a.duration):a.noteOn(h.t1);return a}var e=k.createGainNode();e.gain.value=0.25;var g=i({},[],[e]);g.level=r({min:0.0010,max:10,audioParam:e.gain,mapping:"log"});g.attackTime=r({min:0.0010,max:10,value:0.02,mapping:"log"});
g.releaseTime=r({min:0.0010,max:10,value:0.1,mapping:"log"});var q;g.load=function(e,h,i){if(q)e.perform(i,h,e.stop);else{var o=h.t1-k.currentTime;u.load_sample(j,function(j){q=j;g.duration=q.duration;e.perform(i,h.jumpTo(k.currentTime+o),e.stop)},l)}};g.trigger=function(e,g){g=g||0;return o.fire(function(j){var k=Math.pow(2,g.valueOf()/12);h(j,k,e.valueOf())})};g.play=o.track([g.load,o.dynamic(function(e){var j=h(e,e.rate.valueOf(),1);return o.delay(g.duration,function(e){j.playbackRate.value=e.rate.valueOf()})})]);
g.note=function(e,j,k,i){4>arguments.length&&(i=k);return o.dynamic(function(l){var a=h(l,e.valueOf(),1,j,k);a.gain.value=0;a.gain.setTargetAtTime(1,l.t1,g.attackTime.value/3);a.playbackRate.setTargetAtTime(e.valueOf(),l.t1,l.dt/3);return o.track([o.spawn(o.track([o.delay(i),o.fire(function(b){a.gain.setTargetAtTime(0,b.t1,g.releaseTime.value/3);a.stop(b.t1+12*g.releaseTime.value)})])),o.delay(k,function(b){a.playbackRate.exponentialRampToValueAtTime(e.valueOf(),b.t1)})])})};return g};u.sample.clearCache=
u.load_sample.clearCache})();u.jsnode=function(j){var o=j.numberOfInputs||0,l=o+(j.audioParams?j.audioParams.length:0),h=j.numberOfOutputs||1,e=0<l?k.createChannelMerger(l):void 0,g=0<h?k.createChannelSplitter(h):void 0,q=[],n,r,t;n=0;for(r=l;n<r;++n)t=k.createGainNode(),q.push(t),t.connect(e,0,n);var B=[];n=0;for(r=h;n<r;++n)t=k.createGainNode(),B.push(t),g&&g.connect(t,n);var x;x=j.audioParams?Object.keys(j.audioParams):[];var a={},b=[],c=[];a.inputs=b;a.outputs=c;n=0;for(r=x.length;n<r;++n)a[x[n]]=
null;a.playbackTime=k.currentTime;var d=!1,f=!1,p=0,P=Infinity,Q,y=i({},q,B),L=0<x.length?u.dc(1):void 0;x.forEach(function(a,b){var c=q[o+b];y[a]=c.gain;c.gain.value=j.audioParams[a];L.connect(c)});var m=y.keep(k.createScriptProcessor(j.bufferLength||512,l,Math.min(1,h)));e&&e.connect(m);m.onaudioprocess=function(d){var e,g,i,l,m;e=0;if(!f){var n=d.outputBuffer.length;i=Math.floor(k.currentTime*k.sampleRate);l=Math.max(i,p);m=i+n;var q=l-i;i=m-i;if(m>l){e=0;for(g=o;e<g;++e)b[e]=d.inputBuffer.getChannelData(e).subarray(q,
i);e=0;for(g=h;e<g;++e)c[e]=d.outputBuffer.getChannelData(e).subarray(q,i);e=0;for(g=x.length;e<g;++e)a[x[e]]=d.inputBuffer.getChannelData(o+e).subarray(q,i);a.playbackTime=(d.playbackTime||k.currentTime)+q/k.sampleRate;a.samplesToStop=P-l;e=j.onaudioprocess.call(y,a);void 0===e&&(e=m-l)}l+e<m&&(1<=LOG_LEVEL&&console.log("models/jsnode.js[168]:\t","Finished",m,P),f=!0,setTimeout(Q,Math.round(1E3*n/k.sampleRate)))}};var R=g||k.destination;Q=function(){f=!0;m.disconnect();g&&g.disconnect();L&&(L.stop(0),
L.disconnect());e&&e.disconnect();y.drop(m);y.emit&&y.emit("finished")};var I;y.prepareAheadTime=0.1;y.start=function(a){if(!d&&!f)if(a){var b=Math.max(a,k.currentTime)-k.currentTime;I&&(cancelTimeout(I),I=null);var c=function(a){p=Math.floor(a*k.sampleRate);d=true;I=null;m.connect(R)};b<=y.prepareAheadTime?c(a):I=setTimeout(c,Math.round(1E3*(b-y.prepareAheadTime)),a)}else d=!0,m.connect(R)};y.stop=function(a){f||(P=Math.max(p,Math.ceil(a*k.sampleRate)))};0<o&&y.start(0);return y};return u});
